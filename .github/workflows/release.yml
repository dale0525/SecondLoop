name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  preflight:
    runs-on: ubuntu-latest
    outputs:
      runtime_tag: ${{ steps.runtime_preflight.outputs.runtime_tag }}
    env:
      GH_TOKEN: ${{ github.token }}
      GITHUB_TOKEN: ${{ github.token }}
    steps:
      - uses: actions/checkout@v4
      - name: Validate app release tag format
        if: startsWith(github.ref, 'refs/tags/')
        shell: bash
        run: |
          if [[ ! "${GITHUB_REF_NAME}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid app release tag: ${GITHUB_REF_NAME}. Expected vX.Y.Z"
            exit 1
          fi
      - name: Release preflight
        id: runtime_preflight
        shell: bash
        run: |
          set -euo pipefail
          log_file="$(mktemp)"
          bash scripts/release_preflight.sh --repo "${GITHUB_REPOSITORY}" | tee "${log_file}"
          runtime_tag="$(sed -n 's/^release-preflight: resolved_runtime_tag=//p' "${log_file}" | tail -n1)"
          if [[ -z "${runtime_tag}" ]]; then
            echo "Failed to resolve runtime tag from release preflight output"
            exit 1
          fi
          echo "runtime_tag=${runtime_tag}" >> "${GITHUB_OUTPUT}"

  android:
    needs: preflight
    runs-on: ubuntu-latest
    env:
      SECONDLOOP_FIREBASE_WEB_API_KEY: ${{ secrets.SECONDLOOP_FIREBASE_WEB_API_KEY }}
      SECONDLOOP_CLOUD_GATEWAY_BASE_URL_PROD: ${{ secrets.SECONDLOOP_CLOUD_GATEWAY_BASE_URL_PROD }}
      SECONDLOOP_MANAGED_VAULT_BASE_URL_PROD: ${{ secrets.SECONDLOOP_MANAGED_VAULT_BASE_URL_PROD }}
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.19.6"
          channel: stable
          cache: true
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.85.1"
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
      - name: Validate prod config
        shell: bash
        run: |
          : "${SECONDLOOP_FIREBASE_WEB_API_KEY:?Missing secret SECONDLOOP_FIREBASE_WEB_API_KEY}"
          : "${SECONDLOOP_CLOUD_GATEWAY_BASE_URL_PROD:?Missing secret SECONDLOOP_CLOUD_GATEWAY_BASE_URL_PROD}"
          : "${SECONDLOOP_MANAGED_VAULT_BASE_URL_PROD:?Missing secret SECONDLOOP_MANAGED_VAULT_BASE_URL_PROD}"
          if [[ "${SECONDLOOP_CLOUD_GATEWAY_BASE_URL_PROD}" != https://* ]]; then
            echo "Prod gateway URL must start with https://"
            exit 1
          fi
          if [[ "${SECONDLOOP_CLOUD_GATEWAY_BASE_URL_PROD}" == *"staging"* || "${SECONDLOOP_CLOUD_GATEWAY_BASE_URL_PROD}" == *"stage"* ]]; then
            echo "Refusing to build prod release with a staging gateway URL."
            exit 1
          fi
          if [[ "${SECONDLOOP_MANAGED_VAULT_BASE_URL_PROD}" != https://* ]]; then
            echo "Prod managed vault URL must start with https://"
            exit 1
          fi
          if [[ "${SECONDLOOP_MANAGED_VAULT_BASE_URL_PROD}" == *"staging"* || "${SECONDLOOP_MANAGED_VAULT_BASE_URL_PROD}" == *"stage"* ]]; then
            echo "Refusing to build prod release with a staging managed vault URL."
            exit 1
          fi
      - name: Validate Android signing (tag releases)
        if: startsWith(github.ref, 'refs/tags/')
        shell: bash
        run: |
          : "${ANDROID_KEYSTORE_BASE64:?Missing secret ANDROID_KEYSTORE_BASE64}"
          : "${ANDROID_KEYSTORE_PASSWORD:?Missing secret ANDROID_KEYSTORE_PASSWORD}"
          : "${ANDROID_KEY_ALIAS:?Missing secret ANDROID_KEY_ALIAS}"
          : "${ANDROID_KEY_PASSWORD:?Missing secret ANDROID_KEY_PASSWORD}"
      - name: Setup Android signing (tag releases)
        if: startsWith(github.ref, 'refs/tags/')
        shell: bash
        run: |
          mkdir -p android/app
          printf '%s' "${ANDROID_KEYSTORE_BASE64}" | base64 --decode > android/app/upload-keystore.jks
          {
            echo "storePassword=${ANDROID_KEYSTORE_PASSWORD}"
            echo "keyPassword=${ANDROID_KEY_PASSWORD}"
            echo "keyAlias=${ANDROID_KEY_ALIAS}"
            echo "storeFile=app/upload-keystore.jks"
          } > android/key.properties
      - run: flutter pub get
      - name: Build (prod)
        shell: bash
        run: |
          build_number="${GITHUB_RUN_NUMBER}"
          build_name=''
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            candidate="${GITHUB_REF_NAME#v}"
            if [[ "${candidate}" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
              build_name="${BASH_REMATCH[1]}.${BASH_REMATCH[2]}.${BASH_REMATCH[3]}"
            fi
          fi

          build_args=("--build-number=${build_number}")
          if [[ -n "${build_name}" ]]; then
            build_args+=("--build-name=${build_name}")
          fi

          defines=(
            "--dart-define=SECONDLOOP_FIREBASE_WEB_API_KEY=${SECONDLOOP_FIREBASE_WEB_API_KEY}"
            "--dart-define=SECONDLOOP_CLOUD_GATEWAY_BASE_URL=${SECONDLOOP_CLOUD_GATEWAY_BASE_URL_PROD}"
            "--dart-define=SECONDLOOP_MANAGED_VAULT_BASE_URL=${SECONDLOOP_MANAGED_VAULT_BASE_URL_PROD}"
          )
          flutter build apk --release "${build_args[@]}" "${defines[@]}"
          flutter build appbundle --release "${build_args[@]}" "${defines[@]}"
      - name: Package
        shell: bash
        run: |
          mkdir -p dist
          cp build/app/outputs/flutter-apk/app-release.apk "dist/SecondLoop-android-${GITHUB_REF_NAME}.apk"
          cp build/app/outputs/bundle/release/app-release.aab "dist/SecondLoop-android-${GITHUB_REF_NAME}.aab"
      - uses: actions/upload-artifact@v4
        with:
          name: android
          path: dist/*.a*

  windows:
    needs: preflight
    runs-on: windows-latest
    env:
      SECONDLOOP_FIREBASE_WEB_API_KEY: ${{ secrets.SECONDLOOP_FIREBASE_WEB_API_KEY }}
      SECONDLOOP_CLOUD_GATEWAY_BASE_URL_PROD: ${{ secrets.SECONDLOOP_CLOUD_GATEWAY_BASE_URL_PROD }}
      SECONDLOOP_MANAGED_VAULT_BASE_URL_PROD: ${{ secrets.SECONDLOOP_MANAGED_VAULT_BASE_URL_PROD }}
      SECONDLOOP_DESKTOP_RUNTIME_TAG: ${{ needs.preflight.outputs.runtime_tag }}
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.19.6"
          channel: stable
          cache: true
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.85.1"
      - name: Validate prod config
        shell: pwsh
        run: |
          if (-not $Env:SECONDLOOP_FIREBASE_WEB_API_KEY) { throw "Missing secret SECONDLOOP_FIREBASE_WEB_API_KEY" }
          if (-not $Env:SECONDLOOP_CLOUD_GATEWAY_BASE_URL_PROD) { throw "Missing secret SECONDLOOP_CLOUD_GATEWAY_BASE_URL_PROD" }
          if (-not $Env:SECONDLOOP_MANAGED_VAULT_BASE_URL_PROD) { throw "Missing secret SECONDLOOP_MANAGED_VAULT_BASE_URL_PROD" }
          if (-not $Env:SECONDLOOP_DESKTOP_RUNTIME_TAG) { throw "Missing runtime tag resolved by preflight" }
          if ($Env:SECONDLOOP_DESKTOP_RUNTIME_TAG -notmatch '^desktop-runtime-v\d+\.\d+\.\d+(\.\d+)?$') { throw "Invalid SECONDLOOP_DESKTOP_RUNTIME_TAG: $Env:SECONDLOOP_DESKTOP_RUNTIME_TAG" }
          if (-not $Env:SECONDLOOP_CLOUD_GATEWAY_BASE_URL_PROD.StartsWith("https://")) { throw "Prod gateway URL must start with https://" }
          if ($Env:SECONDLOOP_CLOUD_GATEWAY_BASE_URL_PROD -match "staging" -or $Env:SECONDLOOP_CLOUD_GATEWAY_BASE_URL_PROD -match "stage") { throw "Refusing to build prod release with a staging gateway URL." }
          if (-not $Env:SECONDLOOP_MANAGED_VAULT_BASE_URL_PROD.StartsWith("https://")) { throw "Prod managed vault URL must start with https://" }
          if ($Env:SECONDLOOP_MANAGED_VAULT_BASE_URL_PROD -match "staging" -or $Env:SECONDLOOP_MANAGED_VAULT_BASE_URL_PROD -match "stage") { throw "Refusing to build prod release with a staging managed vault URL." }
      - run: flutter pub get
      - name: Prepare desktop runtime assets
        shell: pwsh
        run: |
          $runtimeArch = if ($Env:PROCESSOR_ARCHITECTURE -match 'ARM64') { 'arm64' } else { 'x64' }
          dart run tools/prepare_desktop_runtime.dart `
            --platform=windows `
            --arch=$runtimeArch `
            --runtime-tag=$Env:SECONDLOOP_DESKTOP_RUNTIME_TAG `
            --require-runtime-tag `
            --repo=$Env:GITHUB_REPOSITORY
      - name: Install FFmpeg
        shell: pwsh
        run: choco install ffmpeg --yes --no-progress
      - name: Prepare bundled FFmpeg
        shell: pwsh
        run: dart run tools/prepare_bundled_ffmpeg.dart --platform=windows --source-bin "C:\ProgramData\chocolatey\bin\ffmpeg.exe"
      - name: Build (prod)
        shell: pwsh
        run: |
          $buildArgs = @("--build-number=$Env:GITHUB_RUN_NUMBER")
          if ($Env:GITHUB_REF -like "refs/tags/v*") {
            $candidate = $Env:GITHUB_REF_NAME.Substring(1)
            if ($candidate -match '^(\d+)\.(\d+)\.(\d+)$') {
              $buildArgs += "--build-name=$($Matches[1]).$($Matches[2]).$($Matches[3])"
            }
          }
          $defines = @(
            "--dart-define=SECONDLOOP_FIREBASE_WEB_API_KEY=$Env:SECONDLOOP_FIREBASE_WEB_API_KEY",
            "--dart-define=SECONDLOOP_CLOUD_GATEWAY_BASE_URL=$Env:SECONDLOOP_CLOUD_GATEWAY_BASE_URL_PROD",
            "--dart-define=SECONDLOOP_MANAGED_VAULT_BASE_URL=$Env:SECONDLOOP_MANAGED_VAULT_BASE_URL_PROD"
          )
          flutter build windows --release @buildArgs @defines
      - name: Package
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          $zip = "dist/SecondLoop-windows-x64-$Env:GITHUB_REF_NAME.zip"
          if (Test-Path $zip) { Remove-Item $zip -Force }
          Compress-Archive -Path "build/windows/x64/runner/Release/*" -DestinationPath $zip
      - uses: actions/upload-artifact@v4
        with:
          name: windows
          path: dist/*.zip

  macos:
    needs: preflight
    runs-on: macos-latest
    env:
      SECONDLOOP_FIREBASE_WEB_API_KEY: ${{ secrets.SECONDLOOP_FIREBASE_WEB_API_KEY }}
      SECONDLOOP_CLOUD_GATEWAY_BASE_URL_PROD: ${{ secrets.SECONDLOOP_CLOUD_GATEWAY_BASE_URL_PROD }}
      SECONDLOOP_MANAGED_VAULT_BASE_URL_PROD: ${{ secrets.SECONDLOOP_MANAGED_VAULT_BASE_URL_PROD }}
      SECONDLOOP_DESKTOP_RUNTIME_TAG: ${{ needs.preflight.outputs.runtime_tag }}
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.19.6"
          channel: stable
          cache: true
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.85.1"
      - name: Install CocoaPods
        shell: bash
        run: |
          if ! gem list -i cocoapods -v 1.16.2 >/dev/null 2>&1; then
            sudo gem install cocoapods -v 1.16.2
          fi
      - name: Validate prod config
        shell: bash
        run: |
          : "${SECONDLOOP_FIREBASE_WEB_API_KEY:?Missing secret SECONDLOOP_FIREBASE_WEB_API_KEY}"
          : "${SECONDLOOP_CLOUD_GATEWAY_BASE_URL_PROD:?Missing secret SECONDLOOP_CLOUD_GATEWAY_BASE_URL_PROD}"
          : "${SECONDLOOP_MANAGED_VAULT_BASE_URL_PROD:?Missing secret SECONDLOOP_MANAGED_VAULT_BASE_URL_PROD}"
          : "${SECONDLOOP_DESKTOP_RUNTIME_TAG:?Missing runtime tag resolved by preflight}"
          if [[ ! "${SECONDLOOP_DESKTOP_RUNTIME_TAG}" =~ ^desktop-runtime-v[0-9]+\.[0-9]+\.[0-9]+(\.[0-9]+)?$ ]]; then
            echo "Invalid SECONDLOOP_DESKTOP_RUNTIME_TAG: ${SECONDLOOP_DESKTOP_RUNTIME_TAG}"
            exit 1
          fi
          if [[ "${SECONDLOOP_CLOUD_GATEWAY_BASE_URL_PROD}" != https://* ]]; then
            echo "Prod gateway URL must start with https://"
            exit 1
          fi
          if [[ "${SECONDLOOP_CLOUD_GATEWAY_BASE_URL_PROD}" == *"staging"* || "${SECONDLOOP_CLOUD_GATEWAY_BASE_URL_PROD}" == *"stage"* ]]; then
            echo "Refusing to build prod release with a staging gateway URL."
            exit 1
          fi
          if [[ "${SECONDLOOP_MANAGED_VAULT_BASE_URL_PROD}" != https://* ]]; then
            echo "Prod managed vault URL must start with https://"
            exit 1
          fi
          if [[ "${SECONDLOOP_MANAGED_VAULT_BASE_URL_PROD}" == *"staging"* || "${SECONDLOOP_MANAGED_VAULT_BASE_URL_PROD}" == *"stage"* ]]; then
            echo "Refusing to build prod release with a staging managed vault URL."
            exit 1
          fi
      - run: flutter pub get
      - name: Prepare desktop runtime assets
        shell: bash
        run: |
          set -euo pipefail
          runtime_arch='x64'
          host_arch="$(uname -m)"
          case "${host_arch}" in
            arm64|aarch64) runtime_arch='arm64' ;;
            x86_64|amd64) runtime_arch='x64' ;;
          esac
          dart run tools/prepare_desktop_runtime.dart \
            --platform=macos \
            --arch="${runtime_arch}" \
            --runtime-tag="${SECONDLOOP_DESKTOP_RUNTIME_TAG}" \
            --require-runtime-tag \
            --repo="${GITHUB_REPOSITORY}"
      - name: Install FFmpeg
        shell: bash
        run: brew install ffmpeg
      - name: Prepare bundled FFmpeg
        shell: bash
        run: dart run tools/prepare_bundled_ffmpeg.dart --platform=macos
      - name: Build (prod)
        shell: bash
        run: |
          build_number="${GITHUB_RUN_NUMBER}"
          build_name=''
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            candidate="${GITHUB_REF_NAME#v}"
            if [[ "${candidate}" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
              build_name="${BASH_REMATCH[1]}.${BASH_REMATCH[2]}.${BASH_REMATCH[3]}"
            fi
          fi

          build_args=("--build-number=${build_number}")
          if [[ -n "${build_name}" ]]; then
            build_args+=("--build-name=${build_name}")
          fi

          defines=(
            "--dart-define=SECONDLOOP_FIREBASE_WEB_API_KEY=${SECONDLOOP_FIREBASE_WEB_API_KEY}"
            "--dart-define=SECONDLOOP_CLOUD_GATEWAY_BASE_URL=${SECONDLOOP_CLOUD_GATEWAY_BASE_URL_PROD}"
            "--dart-define=SECONDLOOP_MANAGED_VAULT_BASE_URL=${SECONDLOOP_MANAGED_VAULT_BASE_URL_PROD}"
          )
          # flutter build macos defaults to code signing and fails on CI without Apple certs.
          # Use config-only to generate build settings (build name/number + dart-defines),
          # then build with xcodebuild while explicitly disabling code signing.
          flutter build macos --release --config-only "${build_args[@]}" "${defines[@]}"
          (cd macos && pod install)
          xcodebuild \
            -workspace macos/Runner.xcworkspace \
            -configuration Release \
            -scheme Runner \
            -derivedDataPath "$PWD/build/macos" \
            -destination platform=macOS \
            OBJROOT="$PWD/build/macos/Build/Intermediates.noindex" \
            SYMROOT="$PWD/build/macos/Build/Products" \
            COMPILER_INDEX_STORE_ENABLE=NO \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            DEVELOPMENT_TEAM=""
      - name: Package
        shell: bash
        run: |
          mkdir -p dist
          # NOTE: .app is a directory; `ls` without `-d` would list its contents (e.g. "Contents").
          app="$(ls -1d build/macos/Build/Products/Release/*.app | head -n 1)"
          stage_dir="$(mktemp -d)"
          cp -R "${app}" "${stage_dir}/"
          dmg_path="dist/SecondLoop-macos-${GITHUB_REF_NAME}.dmg"
          rm -f "${dmg_path}"
          hdiutil create -volname "SecondLoop" -srcfolder "${stage_dir}" -ov -format UDZO "${dmg_path}"
      - uses: actions/upload-artifact@v4
        with:
          name: macos
          path: dist/*.dmg

  linux:
    needs: preflight
    runs-on: ubuntu-latest
    env:
      SECONDLOOP_FIREBASE_WEB_API_KEY: ${{ secrets.SECONDLOOP_FIREBASE_WEB_API_KEY }}
      SECONDLOOP_CLOUD_GATEWAY_BASE_URL_PROD: ${{ secrets.SECONDLOOP_CLOUD_GATEWAY_BASE_URL_PROD }}
      SECONDLOOP_MANAGED_VAULT_BASE_URL_PROD: ${{ secrets.SECONDLOOP_MANAGED_VAULT_BASE_URL_PROD }}
      SECONDLOOP_DESKTOP_RUNTIME_TAG: ${{ needs.preflight.outputs.runtime_tag }}
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.19.6"
          channel: stable
          cache: true
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.85.1"
      - name: Install Linux build dependencies
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang \
            cmake \
            ffmpeg \
            libgtk-3-dev \
            libkeybinder-3.0-dev \
            liblzma-dev \
            libsecret-1-dev \
            ninja-build \
            pkg-config \
            libpoppler-glib-dev \
            tesseract-ocr
      - name: Validate prod config
        shell: bash
        run: |
          : "${SECONDLOOP_FIREBASE_WEB_API_KEY:?Missing secret SECONDLOOP_FIREBASE_WEB_API_KEY}"
          : "${SECONDLOOP_CLOUD_GATEWAY_BASE_URL_PROD:?Missing secret SECONDLOOP_CLOUD_GATEWAY_BASE_URL_PROD}"
          : "${SECONDLOOP_MANAGED_VAULT_BASE_URL_PROD:?Missing secret SECONDLOOP_MANAGED_VAULT_BASE_URL_PROD}"
          : "${SECONDLOOP_DESKTOP_RUNTIME_TAG:?Missing runtime tag resolved by preflight}"
          if [[ ! "${SECONDLOOP_DESKTOP_RUNTIME_TAG}" =~ ^desktop-runtime-v[0-9]+\.[0-9]+\.[0-9]+(\.[0-9]+)?$ ]]; then
            echo "Invalid SECONDLOOP_DESKTOP_RUNTIME_TAG: ${SECONDLOOP_DESKTOP_RUNTIME_TAG}"
            exit 1
          fi
          if [[ "${SECONDLOOP_CLOUD_GATEWAY_BASE_URL_PROD}" != https://* ]]; then
            echo "Prod gateway URL must start with https://"
            exit 1
          fi
          if [[ "${SECONDLOOP_CLOUD_GATEWAY_BASE_URL_PROD}" == *"staging"* || "${SECONDLOOP_CLOUD_GATEWAY_BASE_URL_PROD}" == *"stage"* ]]; then
            echo "Refusing to build prod release with a staging gateway URL."
            exit 1
          fi
          if [[ "${SECONDLOOP_MANAGED_VAULT_BASE_URL_PROD}" != https://* ]]; then
            echo "Prod managed vault URL must start with https://"
            exit 1
          fi
          if [[ "${SECONDLOOP_MANAGED_VAULT_BASE_URL_PROD}" == *"staging"* || "${SECONDLOOP_MANAGED_VAULT_BASE_URL_PROD}" == *"stage"* ]]; then
            echo "Refusing to build prod release with a staging managed vault URL."
            exit 1
          fi
      - run: flutter pub get
      - name: Prepare desktop runtime assets
        shell: bash
        run: |
          set -euo pipefail
          dart run tools/prepare_desktop_runtime.dart \
            --platform=linux \
            --arch=x64 \
            --runtime-tag="${SECONDLOOP_DESKTOP_RUNTIME_TAG}" \
            --require-runtime-tag \
            --repo="${GITHUB_REPOSITORY}"
      - name: Prepare bundled FFmpeg
        shell: bash
        run: dart run tools/prepare_bundled_ffmpeg.dart --platform=linux
      - name: Build (prod)
        shell: bash
        run: |
          build_number="${GITHUB_RUN_NUMBER}"
          build_name=''
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            candidate="${GITHUB_REF_NAME#v}"
            if [[ "${candidate}" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
              build_name="${BASH_REMATCH[1]}.${BASH_REMATCH[2]}.${BASH_REMATCH[3]}"
            fi
          fi

          build_args=("--build-number=${build_number}")
          if [[ -n "${build_name}" ]]; then
            build_args+=("--build-name=${build_name}")
          fi

          defines=(
            "--dart-define=SECONDLOOP_FIREBASE_WEB_API_KEY=${SECONDLOOP_FIREBASE_WEB_API_KEY}"
            "--dart-define=SECONDLOOP_CLOUD_GATEWAY_BASE_URL=${SECONDLOOP_CLOUD_GATEWAY_BASE_URL_PROD}"
            "--dart-define=SECONDLOOP_MANAGED_VAULT_BASE_URL=${SECONDLOOP_MANAGED_VAULT_BASE_URL_PROD}"
          )
          flutter build linux --release "${build_args[@]}" "${defines[@]}"
      - name: Package
        shell: bash
        run: |
          mkdir -p dist
          tar -C build/linux/x64/release -czf "dist/SecondLoop-linux-x64-${GITHUB_REF_NAME}.tar.gz" bundle
      - uses: actions/upload-artifact@v4
        with:
          name: linux
          path: dist/*.tar.gz

  publish:
    runs-on: ubuntu-latest
    needs: [preflight, android, windows, macos, linux]
    if: startsWith(github.ref, 'refs/tags/')
    env:
      RELEASE_LLM_BASE_URL: ${{ secrets.RELEASE_LLM_BASE_URL || 'https://api.openai.com/v1' }}
      RELEASE_LLM_MODEL: ${{ secrets.RELEASE_LLM_MODEL }}
      RELEASE_NOTES_LOCALES: ${{ vars.RELEASE_NOTES_LOCALES || 'zh-CN,en-US' }}
      RELEASE_LLM_API_KEY: ${{ secrets.RELEASE_LLM_API_KEY }}
      GH_TOKEN: ${{ github.token }}
      GITHUB_TOKEN: ${{ github.token }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true
      - name: Validate release-note LLM config
        shell: bash
        run: |
          : "${RELEASE_LLM_API_KEY:?Missing secret RELEASE_LLM_API_KEY}"
          : "${RELEASE_LLM_MODEL:?Missing secret RELEASE_LLM_MODEL}"
          if [[ ! "${GITHUB_REF_NAME}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid app release tag: ${GITHUB_REF_NAME}. Expected vX.Y.Z"
            exit 1
          fi
      - name: Collect release facts
        shell: bash
        run: |
          set -euo pipefail
          python3 scripts/release_ai.py collect-facts \
            --repo "${GITHUB_REPOSITORY}" \
            --base-tag auto \
            --auto-base-source github-releases \
            --head-tag "${GITHUB_REF_NAME}" \
            --output dist/release_facts.json
      - name: Generate and validate release notes assets
        shell: bash
        run: |
          set -euo pipefail
          notes_dir='dist/release-notes'
          python3 scripts/release_ai.py generate-notes \
            --facts dist/release_facts.json \
            --tag "${GITHUB_REF_NAME}" \
            --locales "${RELEASE_NOTES_LOCALES}" \
            --output-dir "${notes_dir}"
          python3 scripts/release_ai.py validate-notes \
            --facts dist/release_facts.json \
            --tag "${GITHUB_REF_NAME}" \
            --locales "${RELEASE_NOTES_LOCALES}" \
            --notes-dir "${notes_dir}"
          python3 scripts/release_ai.py render-markdown \
            --tag "${GITHUB_REF_NAME}" \
            --locales "${RELEASE_NOTES_LOCALES}" \
            --notes-dir "${notes_dir}" \
            --output dist/release-notes.md
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: dist/release-notes.md
          files: |
            dist/*.apk
            dist/*.aab
            dist/*.dmg
            dist/*.zip
            dist/*.tar.gz
            dist/release-notes/*.json
            dist/release-notes.md
