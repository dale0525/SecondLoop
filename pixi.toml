[workspace]
authors = ["Logic Tan <logictan89@gmail.com>"]
channels = ["conda-forge"]
name = "SecondLoop"
platforms = ["osx-arm64", "linux-64", "win-64"]
version = "0.1.0"

[tasks]
setup-flutter = "dart pub global activate fvm 2.4.1 && dart pub global run fvm:main install 3.19.6 && dart pub global run fvm:main use 3.19.6 --force && dart pub global run fvm:main flutter pub get"
init-env = "bash scripts/init_env.sh"
install-git-hooks = "bash scripts/install_git_hooks.sh"
release = "bash scripts/release_tag.sh"
setup-android-sdk = "bash scripts/setup_android_sdk.sh"
setup-rustup = "bash scripts/setup_rustup.sh"
doctor = "dart pub global run fvm:main flutter doctor -v"
analyze = "dart pub global run fvm:main flutter analyze"
test = "dart pub global run fvm:main flutter test"
clean = "dart pub global run fvm:main flutter clean"
format = "dart pub global run fvm:main dart format --output=none lib test rust_builder integration_test test_driver --set-exit-if-changed"
format-fix = "dart pub global run fvm:main dart format lib test rust_builder integration_test test_driver"
rust-fmt-fix = "cargo fmt --manifest-path rust/Cargo.toml --all"
fmt = { depends-on = ["format-fix", "rust-fmt-fix"] }
fmt-check = { depends-on = ["format", "rust-fmt"] }
ci = { depends-on = ["fmt-check", "analyze", "test", "rust-clippy", "rust-test"] }
run-android = { cmd = "env CARGO_HOME=\"$PWD/.tool/cargo\" RUSTUP_HOME=\"$PWD/.tool/rustup\" ANDROID_SDK_ROOT=\"$PWD/.tool/android-sdk\" ANDROID_HOME=\"$PWD/.tool/android-sdk\" ANDROID_USER_HOME=\"$PWD/.tool/android\" GRADLE_USER_HOME=\"$PWD/.tool/gradle\" bash scripts/flutter_with_defines.sh run -d android", depends-on = ["setup-android-sdk", "setup-rustup"] }
build-android-apk = { cmd = "env CARGO_HOME=\"$PWD/.tool/cargo\" RUSTUP_HOME=\"$PWD/.tool/rustup\" ANDROID_SDK_ROOT=\"$PWD/.tool/android-sdk\" ANDROID_HOME=\"$PWD/.tool/android-sdk\" ANDROID_USER_HOME=\"$PWD/.tool/android\" GRADLE_USER_HOME=\"$PWD/.tool/gradle\" bash scripts/flutter_with_defines.sh build apk --release", depends-on = ["setup-android-sdk", "setup-rustup"] }
run-android-cn = { cmd = "env SECONDLOOP_USE_CN_MIRRORS=1 FLUTTER_STORAGE_BASE_URL=https://storage.flutter-io.cn PUB_HOSTED_URL=https://pub.flutter-io.cn RUSTUP_DIST_SERVER=https://rsproxy.cn RUSTUP_UPDATE_ROOT=https://rsproxy.cn/rustup CARGO_HOME=\"$PWD/.tool/cargo\" RUSTUP_HOME=\"$PWD/.tool/rustup\" ANDROID_SDK_ROOT=\"$PWD/.tool/android-sdk\" ANDROID_HOME=\"$PWD/.tool/android-sdk\" ANDROID_USER_HOME=\"$PWD/.tool/android\" GRADLE_USER_HOME=\"$PWD/.tool/gradle\" bash scripts/flutter_with_defines.sh run -d android", depends-on = ["setup-android-sdk", "setup-rustup"] }
build-android-apk-cn = { cmd = "env SECONDLOOP_USE_CN_MIRRORS=1 FLUTTER_STORAGE_BASE_URL=https://storage.flutter-io.cn PUB_HOSTED_URL=https://pub.flutter-io.cn RUSTUP_DIST_SERVER=https://rsproxy.cn RUSTUP_UPDATE_ROOT=https://rsproxy.cn/rustup CARGO_HOME=\"$PWD/.tool/cargo\" RUSTUP_HOME=\"$PWD/.tool/rustup\" ANDROID_SDK_ROOT=\"$PWD/.tool/android-sdk\" ANDROID_HOME=\"$PWD/.tool/android-sdk\" ANDROID_USER_HOME=\"$PWD/.tool/android\" GRADLE_USER_HOME=\"$PWD/.tool/gradle\" bash scripts/flutter_with_defines.sh build apk --release", depends-on = ["setup-android-sdk", "setup-rustup"] }
frb-generate = "env RUST_LOG=info PATH=\"$PWD/.fvm/flutter_sdk/bin:$HOME/.cargo/bin:$PATH\" flutter_rust_bridge_codegen generate --config-file flutter_rust_bridge.yaml"
rust-build-release = "cargo build --manifest-path rust/Cargo.toml --release"
rust-test = "cargo test --manifest-path rust/Cargo.toml"
rust-fmt = "cargo fmt --manifest-path rust/Cargo.toml --all -- --check"
rust-clippy = "cargo clippy --manifest-path rust/Cargo.toml --all-targets --all-features -- -D warnings"
i18n-gen = "dart pub global run fvm:main dart run slang && dart pub global run fvm:main dart format lib/i18n/strings.g.dart"
i18n-translate = "python tools/i18n_translate.py"
i18n-sync = { depends-on = ["i18n-translate", "i18n-gen"] }

[dependencies]
rust = "1.85.*"
python = "3.11.*"
cmake = ">=4.2.1,<5"
ninja = ">=1.13.2,<2"
dart-sdk = "2.18.2.*"
openjdk = "17.*"

[target.osx-arm64.dependencies]
ruby = ">=3.4.8,<4"
clang_osx-arm64 = ">=21.1.8,<22"
clangxx_osx-arm64 = ">=21.1.8,<22"

[target.osx-arm64.tasks]
setup-cocoapods = "gem list -i cocoapods -v 1.16.2 || gem install cocoapods -v 1.16.2"
run-macos = { cmd = "env -u AR -u CC -u CFLAGS -u CPPFLAGS -u CXX -u CXXFLAGS -u LD -u LDFLAGS -u NM -u RANLIB -u SDKROOT -u STRIP LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8 bash scripts/flutter_with_defines.sh run -d macos", depends-on = ["setup-cocoapods"] }

[target.win-64.tasks]
frb-generate = "powershell -NoProfile -ExecutionPolicy Bypass -File scripts/frb_generate.ps1"
setup-nuget = "powershell -NoProfile -ExecutionPolicy Bypass -File scripts/setup_nuget.ps1"
setup-windows = { cmd = "echo setup-windows ok", depends-on = ["setup-flutter", "setup-nuget"] }
run-windows = { cmd = "powershell -NoProfile -ExecutionPolicy Bypass -File scripts/run_windows.ps1", depends-on = ["setup-windows"] }
