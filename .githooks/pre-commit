#!/usr/bin/env bash
set -euo pipefail

die() {
  echo "pre-commit: $*" >&2
  exit 1
}

repo_root="$(git rev-parse --show-toplevel 2>/dev/null || true)"
if [[ -z "${repo_root}" ]]; then
  exit 0
fi

cd "${repo_root}"

staged_files=()
while IFS= read -r file; do
  staged_files+=("${file}")
done < <(git diff --cached --name-only --diff-filter=ACMR)

if [[ ${#staged_files[@]} -eq 0 ]]; then
  exit 0
fi

dart_files=()
run_rust_fmt=0
run_flutter_checks=0
for file in "${staged_files[@]}"; do
  if [[ "${file}" == *.dart ]]; then
    dart_files+=("${file}")
    run_flutter_checks=1
    continue
  fi

  case "${file}" in
    analysis_options.yaml | pubspec.yaml | pubspec.lock)
      run_flutter_checks=1
      ;;
  esac

  case "${file}" in
    rust/*) run_rust_fmt=1 ;;
  esac
done

if [[ ${#dart_files[@]} -eq 0 && ${run_flutter_checks} -eq 0 && ${run_rust_fmt} -eq 0 ]]; then
  exit 0
fi

dart_bin=""
if [[ ${#dart_files[@]} -ne 0 ]]; then
  if [[ -x "${repo_root}/.fvm/flutter_sdk/bin/dart" ]]; then
    dart_bin="${repo_root}/.fvm/flutter_sdk/bin/dart"
  elif command -v dart >/dev/null 2>&1; then
    dart_bin="$(command -v dart)"
  else
    die "Missing 'dart'. Install Flutter (recommended: \`pixi run setup-flutter\`) or add Dart to PATH."
  fi
fi

flutter_bin=""
if [[ ${run_flutter_checks} -ne 0 ]]; then
  if [[ -x "${repo_root}/.fvm/flutter_sdk/bin/flutter" ]]; then
    flutter_bin="${repo_root}/.fvm/flutter_sdk/bin/flutter"
  elif command -v flutter >/dev/null 2>&1; then
    flutter_bin="$(command -v flutter)"
  else
    die "Missing 'flutter'. Install Flutter (recommended: \`pixi run setup-flutter\`) or add Flutter to PATH."
  fi
fi

cargo_bin=""
if [[ ${run_rust_fmt} -ne 0 ]]; then
  if [[ -x "${repo_root}/.tool/cargo/bin/cargo" ]]; then
    cargo_bin="${repo_root}/.tool/cargo/bin/cargo"
  elif command -v cargo >/dev/null 2>&1; then
    cargo_bin="$(command -v cargo)"
  else
    die "Missing 'cargo'. Install Rust (recommended: \`pixi run setup-rustup\`) or add cargo to PATH."
  fi
fi

stashed=0
cleanup() {
  if (( stashed )); then
    if ! git stash pop -q; then
      trap - EXIT
      echo "pre-commit: Failed to restore unstaged changes from stash. Resolve conflicts and re-run commit." >&2
      exit 1
    fi
  fi
}
trap cleanup EXIT

if ! git diff --quiet || [[ -n "$(git ls-files --others --exclude-standard)" ]]; then
  git stash push -k -u -q -m "pre-commit(worktree)"
  stashed=1
fi

if [[ ${#dart_files[@]} -ne 0 ]]; then
  "${dart_bin}" format "${dart_files[@]}"
  git add -- "${dart_files[@]}"
fi

if [[ ${run_rust_fmt} -ne 0 ]]; then
  if ! "${cargo_bin}" fmt --manifest-path rust/Cargo.toml --all; then
    echo "" >&2
    echo "pre-commit: rustfmt failed." >&2
    echo "Fix locally with: pixi run rust-fmt-fix" >&2
    exit 1
  fi
  git add -u -- rust
fi

if [[ ${run_flutter_checks} -ne 0 ]]; then
  if ! env -u GIT_DIR -u GIT_WORK_TREE -u GIT_INDEX_FILE "${flutter_bin}" analyze; then
    echo "" >&2
    echo "pre-commit: flutter analyze failed." >&2
    echo "Fix locally with: pixi run analyze" >&2
    exit 1
  fi
fi
